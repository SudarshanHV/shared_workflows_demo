name: Simple CI

on:
  workflow_call:
    inputs:
      app-name:
        required: true
        type: string
      test-command:
        required: false
        type: string
        default: "echo 'No tests configured'"
      sonar-project-key:
        required: true
        type: string
      sonar-host-url:
        required: true
        type: string
      enable-coverage:
        required: false
        type: boolean
        default: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup coverage
        run: |
          if [ -f "package.json" ]; then
            # Install nyc if not present and no other coverage tool detected
            if ! npm list jest nyc vitest --depth=0 > /dev/null 2>&1; then
              npm install --save-dev nyc
              export TEST_CMD="npx nyc --reporter=lcov ${{ inputs.test-command }}"
            else
              export TEST_CMD="${{ inputs.test-command }}"
            fi
            echo "FINAL_TEST_COMMAND=$TEST_CMD" >> $GITHUB_ENV
          fi

      - name: Run tests for ${{ inputs.app-name }}
        run: ${FINAL_TEST_COMMAND:-${{ inputs.test-command }}}

      
      - name: Upload Coverage to SonarQube
        env:
          SONAR_TOKEN: ${{ secrets. SONAR_TOKEN}}
        run: |
          wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.6.2.2472-linux.zip
          unzip sonar-scanner-cli-4.6.2.2472-linux.zip
          export PATH="$PATH:$(pwd)/sonar-scanner-4.6.2.2472-linux/bin"
          sonar-scanner \
            -Dsonar.projectKey=${{ inputs.sonar-project-key }} \
            -Dsonar.host.url=${{ inputs.sonar-host-url }} \
            -Dsonar.login=$SONAR_TOKEN \
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
      
      - name: Build success
        run: echo "${{ inputs.app-name }} built successfully!"
